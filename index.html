<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gestión y Ventas Profesional</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome para iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
        .header-title { background-color: #0d6efd; color: white; padding: 20px; border-radius: 8px; text-align: center; }
        .card-custom { border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-primary-custom { background-color: #0d6efd; border: none; }
        .btn-success-custom { background-color: #198754; }
        .btn-warning-custom { background-color: #ffc107; color: #212529; }
        .btn-danger-custom { background-color: #dc3545; }
        .table th { background-color: #e9ecef; }
        .moneda { font-weight: bold; }
        .beneficio { color: #198754; font-weight: bold; }
        .comision { color: #fd7e14; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="header-title mb-4">
            <h1><i class="fas fa-cash-register"></i> SISTEMA DE GESTIÓN Y VENTAS PROFESIONAL</h1>
            <p class="mb-0" id="fecha-hora"></p>
        </div>

        <div id="pantalla-inicio" class="text-center mb-4"></div>

        <div id="contenido"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        class SistemaVentas {
            constructor() {
                this.productos = this.cargar('productos') || [];
                this.clientes = this.cargar('clientes') || [];
                this.vendedores = this.cargar('vendedores') || [];
                this.ventas = this.cargar('ventas') || [];
                this.actualizarFechaHora();
                setInterval(() => this.actualizarFechaHora(), 1000);
                this.pantallaInicio();
            }

            cargar(key) {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : [];
            }

            guardar(key, data) {
                localStorage.setItem(key, JSON.stringify(data));
            }

            formatoMonedaEntero(valor) {
                const entero = Math.floor(valor);
                return entero.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
            }

            actualizarFechaHora() {
                const ahora = new Date();
                const fecha = ahora.toLocaleDateString('es-ES');
                const hora = ahora.toLocaleTimeString('es-ES');
                document.getElementById('fecha-hora').textContent = `Fecha: ${fecha} | Hora: ${hora}`;
            }

            pantallaInicio() {
                document.getElementById('pantalla-inicio').innerHTML = `
                    <div class="row text-center">
                        <div class="col-md-3"><div class="card card-custom p-3"><h5>Productos</h5><h3>${this.productos.length}</h3></div></div>
                        <div class="col-md-3"><div class="card card-custom p-3"><h5>Clientes</h5><h3>${this.clientes.length}</h3></div></div>
                        <div class="col-md-3"><div class="card card-custom p-3"><h5>Vendedores</h5><h3>${this.vendedores.length}</h3></div></div>
                        <div class="col-md-3"><div class="card card-custom p-3"><h5>Ventas</h5><h3>${this.ventas.length}</h3></div></div>
                    </div>
                `;
                this.mostrarMenuPrincipal();
            }

            mostrarMenuPrincipal() {
                document.getElementById('contenido').innerHTML = `
                    <div class="row justify-content-center">
                        <div class="col-md-6">
                            <div class="list-group mt-4">
                                <button class="list-group-item list-group-item-action btn-primary-custom text-white fs-5" onclick="sistema.menuVentas()">
                                    <i class="fas fa-shopping-cart"></i> 1. VENTAS
                                </button>
                                <button class="list-group-item list-group-item-action btn-primary-custom text-white fs-5" onclick="sistema.menuProductos()">
                                    <i class="fas fa-box"></i> 2. PRODUCTOS
                                </button>
                                <button class="list-group-item list-group-item-action btn-primary-custom text-white fs-5" onclick="sistema.menuClientes()">
                                    <i class="fas fa-users"></i> 3. CLIENTES
                                </button>
                                <button class="list-group-item list-group-item-action btn-primary-custom text-white fs-5" onclick="sistema.menuVendedores()">
                                    <i class="fas fa-user-tie"></i> 4. VENDEDORES
                                </button>
                                <button class="list-group-item list-group-item-action btn-danger-custom text-white fs-5" onclick="sistema.salir()">
                                    <i class="fas fa-sign-out-alt"></i> 5. SALIR
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // ===== MÓDULOS =====
            menuVentas() {
                document.getElementById('contenido').innerHTML = `
                    <h3 class="text-center mb-4"><i class="fas fa-shopping-cart"></i> MÓDULO DE VENTAS</h3>
                    <div class="list-group">
                        <button class="list-group-item list-group-item-action btn-success-custom" onclick="sistema.registrarVenta()">1. Registrar Venta</button>
                        <button class="list-group-item list-group-item-action" onclick="sistema.listarVentas()">2. Listar Ventas (Histórico)</button>
                        <button class="list-group-item list-group-item-action" onclick="sistema.menuReportesVentas()">3. Reportes</button>
                        <button class="list-group-item list-group-item-action btn-warning-custom" onclick="sistema.mostrarMenuPrincipal()">4. Volver al Menú Principal</button>
                    </div>
                `;
            }

            registrarVenta() {
                if (this.productos.length === 0) {
                    alert("No hay productos registrados.");
                    return;
                }
                if (this.vendedores.length === 0) {
                    alert("No hay vendedores registrados.");
                    return;
                }

                let html = `<h4>Registrar Nueva Venta</h4><div class="row"><div class="col-md-6">`;

                // Productos
                html += `<h5>Productos disponibles</h5><table class="table table-sm"><thead><tr><th>ID</th><th>Nombre</th><th>Precio</th><th>Stock</th></tr></thead><tbody>`;
                this.productos.forEach(p => {
                    html += `<tr><td>\( {p.id}</td><td> \){p.nombre}</td><td>\[ {this.formatoMonedaEntero(p.precio_venta)}</td><td>${p.stock || 0}</td></tr>`;
                });
                html += `</tbody></table></div><div class="col-md-6">`;

                // Formulario
                html += `<form id="form-venta">
                    <div class="mb-3"><label>ID Producto</label><input type="number" class="form-control" id="prod-id" required></div>
                    <div class="mb-3"><label>Cantidad (1-999)</label><input type="number" min="1" max="999" class="form-control" id="cantidad" required></div>`;

                // Clientes
                html += `<div class="mb-3"><label>Cliente (0 = General)</label><select class="form-select" id="cliente-id"><option value="0">Cliente General</option>`;
                this.clientes.forEach(c => html += `<option value="\( {c.id}"> \){c.id} - ${c.nombre}</option>`);
                html += `</select></div>`;

                // Vendedores
                html += `<div class="mb-3"><label>Vendedor</label><select class="form-select" id="vendedor-id" required>`;
                this.vendedores.forEach(v => html += `<option value="\( {v.id}"> \){v.id} - \( {v.nombre} ( \){v.comision_beneficio || 0}%)</option>`);
                html += `</select></div>`;

                html += `<button type="submit" class="btn btn-success">Confirmar Venta</button> <button type="button" class="btn btn-secondary" onclick="sistema.menuVentas()">Cancelar</button></form></div></div>`;

                document.getElementById('contenido').innerHTML = html;

                document.getElementById('form-venta').onsubmit = (e) => {
                    e.preventDefault();
                    this.procesarVenta();
                };
            }

            procesarVenta() {
                const prodId = parseInt(document.getElementById('prod-id').value);
                const cantidad = parseInt(document.getElementById('cantidad').value);
                const clienteId = parseInt(document.getElementById('cliente-id').value);
                const vendedorId = parseInt(document.getElementById('vendedor-id').value);

                const producto = this.productos.find(p => p.id === prodId);
                if (!producto || cantidad > (producto.stock || 0) || cantidad < 1) {
                    alert("Error: Producto no encontrado o stock insuficiente.");
                    return;
                }

                const cliente = clienteId === 0 ? {id: 0, nombre: "Cliente General"} : this.clientes.find(c => c.id === clienteId);
                const vendedor = this.vendedores.find(v => v.id === vendedorId);

                const subtotal = producto.precio_venta * cantidad;
                const beneficioTotal = producto.beneficio * cantidad;
                const comision = beneficioTotal * (vendedor.comision_beneficio || 0) / 100;

                if (!confirm(`Resumen:\nProducto: ${producto.nombre}\nCantidad: ${cantidad}\nSubtotal: \]{this.formatoMonedaEntero(subtotal)}\nBeneficio: \[ {this.formatoMonedaEntero(beneficioTotal)}\nComisión: \]{this.formatoMonedaEntero(comision)}\nTotal: \[ {this.formatoMonedaEntero(subtotal)}\n\n¿Confirmar?`)) {
                    return;
                }

                const ventaId = this.ventas.length ? Math.max(...this.ventas.map(v => v.id)) + 1 : 1;

                this.ventas.push({
                    id: ventaId,
                    fecha: new Date().toISOString(),
                    producto_id: producto.id,
                    producto_nombre: producto.nombre,
                    precio_compra: producto.precio_compra,
                    beneficio_unitario: producto.beneficio,
                    cliente_id: cliente.id,
                    cliente_nombre: cliente.nombre,
                    vendedor_id: vendedor.id,
                    vendedor_nombre: vendedor.nombre,
                    cantidad,
                    precio_unitario: producto.precio_venta,
                    subtotal,
                    beneficio_total: beneficioTotal,
                    comision,
                    porcentaje_comision: vendedor.comision_beneficio || 0,
                    total: subtotal
                });

                producto.stock = (producto.stock || 0) - cantidad;
                this.guardar('productos', this.productos);
                this.guardar('ventas', this.ventas);
                alert("¡Venta registrada exitosamente!");
                this.menuVentas();
            }

            listarVentas() {
                let html = `<h4 class="text-center">Lista de Ventas (Histórico)</h4>`;
                if (this.ventas.length === 0) {
                    html += `<p class="text-center text-warning">No hay ventas registradas.</p>`;
                } else {
                    html += `<div class="table-responsive"><table class="table table-striped"><thead><tr>
                        <th>ID</th><th>Fecha</th><th>Producto</th><th>Cant</th><th>Subtotal</th><th>Beneficio</th><th>Comisión</th><th>Total</th>
                    </tr></thead><tbody>`;
                    this.ventas.forEach(v => {
                        const fecha = new Date(v.fecha).toLocaleString('es-ES');
                        html += `<tr>
                            <td>${v.id}</td>
                            <td>${fecha}</td>
                            <td>${v.producto_nombre}</td>
                            <td>${v.cantidad}</td>
                            <td class="moneda"> \]{this.formatoMonedaEntero(v.subtotal)}</td>
                            <td class="beneficio">\[ {this.formatoMonedaEntero(v.beneficio_total)}</td>
                            <td class="comision"> \]{this.formatoMonedaEntero(v.comision)}</td>
                            <td class="moneda">$${this.formatoMonedaEntero(v.total)}</td>
                        </tr>`;
                    });
                    html += `</tbody></table></div>`;
                }
                html += `<button class="btn btn-secondary mt-3" onclick="sistema.menuVentas()">Volver</button>`;
                document.getElementById('contenido').innerHTML = html;
            }

            menuReportesVentas() {
                document.getElementById('contenido').innerHTML = `
                    <h3 class="text-center mb-4">REPORTES DE VENTAS Y RENDIMIENTO</h3>
                    <div class="list-group">
                        <button class="list-group-item list-group-item-action" onclick="alert('Función en desarrollo')">1. Ventas Semana Actual</button>
                        <button class="list-group-item list-group-item-action" onclick="alert('Función en desarrollo')">2. Top Clientes y Productos</button>
                        <button class="list-group-item list-group-item-action" onclick="alert('Función en desarrollo')">3. Pago a Vendedores</button>
                        <button class="list-group-item list-group-item-action" onclick="alert('Función en desarrollo')">4. Ventas Semanas Pasadas</button>
                        <button class="list-group-item list-group-item-action btn-warning-custom" onclick="sistema.menuVentas()">5. Volver</button>
                    </div>
                `;
            }

            // Los módulos de Productos, Clientes y Vendedores pueden extenderse de forma similar
            menuProductos() {
                alert("Módulo Productos en desarrollo. Puedes agregar las funciones similares a las de ventas.");
                this.mostrarMenuPrincipal();
            }

            menuClientes() {
                alert("Módulo Clientes en desarrollo.");
                this.mostrarMenuPrincipal();
            }

            menuVendedores() {
                alert("Módulo Vendedores en desarrollo.");
                this.mostrarMenuPrincipal();
            }

            salir() {
                if (confirm("¿Salir del sistema?")) {
                    document.getElementById('contenido').innerHTML = `<h3 class="text-center text-success mt-5">¡Gracias por usar el sistema! Vuelva pronto.</h3>`;
                }
            }
        }

        const sistema = new SistemaVentas();
    </script>
</body>
  </html>
